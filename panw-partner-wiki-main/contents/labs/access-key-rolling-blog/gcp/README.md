# Google Cloud Platform 

Use the following procedure described below to implement rolling a Prisma Cloud Service Account access key in Google Cloud Secret Manager.

Note that the the solution requires use of secret manager, scheduled rotation, and the execution of a Cloud Function - all of which will incur cost.  To remove the solution from your environment, follow the steps in "Cleanup" below.

# Solution
![GCP Example Solution](../images/access_key_blog-gcp.png?raw=true "GCP Example Solution")

The request to roll the Prisma Cloud access key will be generated by Google Secret Manager **(1)** based on the expiration date of the current key **(2)** and will send an event to a PubSub topic. Note that an administrator can also trigger the process by dropping an event on the PubSub topic directly **(3)**.The topic will trigger a Cloud Function **(4)** that will interact with Prisma Cloud and request a new access key **(5)**. The access key will then be stored **(6)** by the Cloud Function into the Secret Manager secret **(7)** as the CURRENT credential. The new credential is now available for downstream automation processes to consume it **(8)**.

# Prerequisites
## Prisma Cloud Service Account
To deploy the sample process, you will need a valid Service Account and Access Key. See [here](../README.md#prerequisites) for instructions on how to create one if necessary.

## Google Cloud credentials
To deploy the sample solution, ensure you have appropriate rights to create the resources listed above in the Solution Diagram.

## Enable secretmanager.googleapis.com
Prior to deploying the solution, ensure that secretmanager.googleapis.com is enabled by executing the following command:

```
gcloud services enable secretmanager.googleapis.com
```
Additionally, you will need to create a service account for secrets manager event notification. This is [documented here](https://cloud.google.com/secret-manager/docs/event-notifications?_gl=1*aip2qw*_ga*NzY0NDE2ODc5LjE3MTA4NTc0OTY.*_ga_WH2QY8WWF5*MTcxMTk4ODAyMS4xMS4xLjE3MTE5ODg1ODUuMC4wLjA.&_ga=2.213479058.-764416879.1710857496#service-account), but esentially it will entail running the following command:

```
gcloud beta services identity create --service "secretmanager.googleapis.com" --project "<YOUR_PROJECT_NAME>"
```

Note that this will retrun the service account identifier (e.g. "service-123456789123@gcp-sa-secretmanager.iam.gserviceaccount.com"), which can then be used to populate the "secretsmanager_service_principal" variable in variables.tf.

## Update variables.tf
Before running the terraform, there are several variables that can be pre-populated with default values so they don't have to be supplied on the command-line:
- region - GCP region (Defaults to "us-east1")
- project_id - GCP project ID this solution will be deployed to
- secret_name - Secret to store - we recommend using the Prisma Cloud Service Account name
- prisma_cloud_console_url - Location of the Prisma Cloud console (e.g. "https://api.prismacloud.io")
- rotation_interval -The number of days between automatic scheduled rotations of the secret (Defaults to 90)
- cloudfunctions2_service_principal - Principal to execute cloud functions (run.invoker) and manage secrets (secretmanager.secretAccessor,secretmanager.secretVersionAdder, secretmanager.secretVersionManager)
- secretsmanager_service_principal - Principal for secrets manager / pubsub interaction (see [Enable secretmanager.googleapis.com] above)
- pubsub_topic_name - Name of the pubsub topic for this solution (Defaults to "prisma-cloud-key-rolling-topic")

# Deployment
Because this is just a testing/sample deployment, we'll make use of Cloud Shell to deploy the infrastructure. Your organization may already have a (more robust) way to execute Terraform - feel free to substitue that if appropriate. 

To deploy the sample solution, execute the following procedure:

1. Open a cloud shell
2. Download the code
4. cd to ./gcp
5. terraform init && terraform apply
7. Enter the variables:
   - initial_access_key - The service account access key id
   - initial_secret_key - The service account secret key id
8. Review and approve the deployment

After several minutes, the deployment should succeed. Be sure to record the output containing pubsub_topic_name and secret_id for later use.

# Validating the deployment
Once deployed, you should see output similar to the following:
```
Apply complete! Resources: 11 added, 0 changed, 0 destroyed.

Outputs:

pubsub_topic_name = "prisma-cloud-key-rolling-topic"
secret_id = "projects/my-project-name/secrets/my-secret-name"
```

The deployment will roll the access key and disable the existing key. The new key will be named in the format "serviceAccountName-date".  Check Prisma Cloud (Settings --> Access Control --> Keys) to ensure that this exists. Additionally, check the value of the secret in Secret Manager to ensure that it has changed from the original input.

# Testing / Manually Rolling the key
To manually test or roll the access key, execute the following in a Cloud Shell:
```
gcloud pubsub topics publish <TOPIC_NAME> --message='MANUAL_ROTATION_REQUESTED|<SECRET_ID>'
```

Note that TOPIC_NAME and SECRET_ID correspond to the terraform output "pubsub_topic_name" and "secret_id", respectively.

# Cleanup
To remove the sample solution from your environment, execute a "terraform destroy" from the initial execution directory.  If you used some other mechanism to deploy the terraform, then destroy the created resources accordingly.

# Extending the solution
The pubsub topic and Cloud Function are able to handle multiple secrets, and the solution can be easily extended by creating and configuring rotation on a new secret manually.


