# AWS

Use the following procedure described below to implement rolling a Prisma Cloud Service Account access key in AWS Secrets Manager.

Note that the the solution requires a Secret in AWS Secrets Manager, and the execution of a Lambda function - both of which will incur cost.  To remove the solution from your environment, follow the steps in [Cleanup](./README.md#cleanup) below.
# Solution
![AWS Example Solution](../images/access_key_blog-aws.png?raw=true "AWS Example Solution")

The example key rolling solution will be triggered by a time-based event **(1)** or administrator action **(2)**. The request will be generated by, or sent to AWS Secrets Manager **(3)** - which acts as the workflow engine. AWS Secrets Manager will use the built-in rotation functionality to call AWS Lambda **(4)**.  AWS Lambda will interact with Prisma Cloud and request a new access key **(5)**.  The access key will then be stored **(6)** by Lambda into AWS Secrets Manager **(7)** as the CURRENT credential. The new credential is now available for downstream automation processes to consume it **(8)**.

# Prerequisites
## Prisma Cloud Service Account
To deploy the sample process, you will need a valid Service Account and Access Key. See [here](../README.md#prerequisites) for instructions on how to create one if necessary.

## Lambda Layer for prismacloud_sdk
We created a Lambda Layer containing [prismacloud_sdk](https://github.com/PaloAltoNetworks/prismacloud-api-python) and boto3 and stored it [here](https://rotating-prisma-cloud-access-keys-blog.s3.amazonaws.com/aws/lambda/layers/prismacloud-sdk/prismacloud-sdk.zip). Feel free to create your own Lambda layer to ensure that the packages are up-to-date and the layer meets your corporate standards.
   
# Deployment
Because this is just a testing/sample deployment, we'll make use of AWS CloudShell to deploy the infrastructure. Your organization may already have a (more robust) way to execute Terraform - go ahead and substitue that if appropriate. 

1. Open a CloudShell
2. Install terraform - if you are unfamiliar, here is a [tutorial](https://dev.to/aws-builders/how-to-install-terraform-on-aws-cloudshell-5had)
3. Create a lambda layer with the prismacloud_sdk and boto3, or [use the one we built](https://rotating-prisma-cloud-access-keys-blog.s3.amazonaws.com/aws/lambda/layers/prismacloud-sdk/prismacloud-sdk.zip). **NOTE:** If you are going to test this in a region other than us-east-1, you will need to copy the Lambda layer to a bucket in your region.
4. Download the code
5. Change directories into aws
6. Run: terraform init && terraform apply
7. Enter the variables:
   - region - AWS region, eg. "us-east-1"
   - rotation_interval - The number of days (1-365) between automatic scheduled rotations of the secret
   - s3_bucket_for_layer - S3 Bucket for the custom lambda layer with the prismacloud-sdk installed
   - s3_key_for_layer - S3 object for the custom lambda layer with the prismacloud-sdk installed
   - initial_access_key - The initial access key to import into the Secret
   - initial_secret_key - The initial secret key to import into the Secret
   - prisma_cloud_console_url - The Prisma Cloud console URL (for example - https://api.prismacloud.io)
   - secret_name - Name of the Secret to store - recommend using the Prisma Cloud Service Account name
8. Approve the deployment
     
# Validating the deployment
Once deployed, you should see output similar to the following:
```
Apply complete! Resources: 8 added, 0 changed, 0 destroyed.

Outputs:
lambda_execution_role_arn = "arn:aws:iam::123456789123:role/your-secret-arn"
```

The deployment will roll the access key and disable the existing key. The new key will be named in the format "serviceAccountName-date".  Check Prisma Cloud (Settings --> Access Control --> Keys) to ensure that this exists. Additionally, check the value of the Secret in Secrets Manager to ensure that it has changed from the original input.

# Testing / Manually Rolling the key
AWS Secrets Manager provides a facility to immediately roll the key.  To do so:
1. Log in to the AWS Console and navigate to Secrets Manager
2. Navigate to the Secret you are using to store the Prisma Cloud credentials
3. Click on the Rotation tab
4. Click Rotate secret immediately
5. Click Rotate
6. In a few moments, ensure that the secret value has changed and that the new key exists in Prisma Cloud

# Cleanup
To remove the sample solution from your environment:
1. Delete the terraform deployment by navigating to the directory you ran the "terraform apply" from (that is, where the state files are) and execute: terraform destroy
2. Delete the Service Account and Access Keys from Prisma Cloud - while these don't incur cost, but best practice is to remove the credentials/accounts if you're not using them

# Extending the solution
## Lambda Layers
Create your own layer - we created and stored one to help facilitate this solution, but it will periodically need to be updated.  Use [this](https://community.aws/content/2d6gQDnHqIbWLLKikuSfwmOZrym/step-by-step-guide-to-creating-an-aws-lambda-function-layer?lang=en) or [this](https://docs.aws.amazon.com/lambda/latest/dg/python-layers.html) as a guide. If you do end up creating and deploying your own layer you may want to remove the resource from the terraform file (main.tf), as it may be more useful to manage the layer with your exisitng CI/CD processes.

## Multiple Service Accounts
The sample solution manages a single Prisma Cloud Service Account using a Lambda function.  The same function could be used to manage multiple Service Accounts / access keys.  Once deployed, the ARN of the Lambda Execution Role will be output from the terraform run.  This role can be manually updated to add additional Secrets ARNs, and new secrets can leverage the existing Lambda funciton to help rotate the credentials.

