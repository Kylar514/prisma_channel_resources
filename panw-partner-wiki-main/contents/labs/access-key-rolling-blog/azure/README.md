# Azure 

Use the following procedure described below to implement rolling a Prisma Cloud Service Account access key in Azure Key Vault.

Note that the the solution requires an Azure Key Vault, scheduled key rotation, and the execution of a Function App - all of which will incur cost.  To remove the solution from your environment, follow the steps in [Cleanup](./README.md#cleanup) below.

# Solution
![Azure Example Solution](../images/access_key_blog-azure.png?raw=true "Azure Example Solution")

The request to roll the Prisma Cloud access key will be generated by Azure Key Vault **(1)** based on the expiration date of the current key **(2)** and will send an event to the Event Grid. The Event Grid will trigger an Azure Function App **(3)** that will interact with Prisma Cloud and request a new access key **(5)**. Note that an administrator can also trigger the process by calling the Azure Function App directly **(4)**. The access key will then be stored **(6)** by the Azure Function App into the Key Vault **(7)** as the CURRENT credential. The new credential is now available for downstream automation processes to consume it **(8)**.

The solution was inspired by a Microsoft Key Vault tutorial - see [here](https://learn.microsoft.com/en-us/azure/key-vault/secrets/tutorial-rotation) for more information.

# Prerequisites
## Prisma Cloud Service Account
To deploy the sample solution, you will need a valid Service Account and Access Key. See [here](../README.md#prerequisites) for instructions on how to create one if necessary.

## Azure credentials
To deploy the sample solution, ensure you have appropriate rights to create the resources listed above in the Solution Diagram.

# Deployment
Because this is just a testing/sample deployment, we'll make use of Azure Cloud Shell to deploy the infrastructure. Your organization may already have a (more robust) way to execute Terraform - feel free to substitue that if appropriate. 

To deploy the sample solution, execute the following procedure:
1. Log in to the Azure console and open a Cloud Shell
2. Download the source code for this example
4. Change directories to 'azure'
5. Run the command: terraform init && terraform apply
7. Enter the variables:
   - region - Azure region, eg. "eastus"
   - resource_group - The resource group name for all of the solution artifacts
   - secret_name - Secret to store - recommend Prisma Cloud Service Account name
   - key_vault_name - Name of the key vault to store secrets
   - initial_access_key - The initial access key to import into the Secret
   - initial_secret_key - The initial secret key to import into the Secret
   - prisma_cloud_console_url - The Prisma Cloud console URL (for example - https://api.prismacloud.io)
   - rotation_interval - The number of days (1-365) between automatic scheduled rotations of the secret
8. Approve the deployment

After several minutes, the deployment should succeed.

# Validating the deployment
Once deployed, you should see output similar to the following:
```
Apply complete! Resources: 14 added, 0 changed, 0 destroyed.
```

The deployment will roll the access key and disable the existing key. The new key will be named in the format "serviceAccountName-date".  Check Prisma Cloud (Settings --> Access Control --> Keys) to ensure that this exists. Additionally, check the value of the Secret in Secrets Manager to ensure that it has changed from the original input.

# Testing / Manually Rolling the key
Azure Key Vault does not provide a facility to roll the secret manually.  To roll the key:

1. Create a new version of the current (valid) secret in the Azure console. Note that the key will be stored in JSON format, as such:
   {"PRISMA_CLOUD_CONSOLE_URL": "https://apiX.prismacloud.io", "PRISMA_CLOUD_PASS": "xxxxxxxxx", "PRISMA_CLOUD_USER": "xxxxxxxxxxxxxxxx"}
2. Add the tag "ROTATE_ON_INITAL" and set the value to true

# Cleanup
To remove the sample solution from your environment:
1. Delete the terraform deployment by navigating to the directory you ran the "terraform apply" from (that is, where the state files are) and execute: terraform destroy
2. Delete the Service Account and Access Keys from Prisma Cloud - while these don't incur cost, but best practice is to remove the credentials/accounts if you're not using them


