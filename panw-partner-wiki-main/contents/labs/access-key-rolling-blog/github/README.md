# GitHub

Use the following procedure described below to implement rolling a Prisma Cloud Service Account access key with GitHub repository secrets.

# Solution
![GitHub Example Solution](../images/access_key_blog-github.png?raw=true "GitHub Example Solution")

The example key rolling solution will be triggered by a time-based event **(1)** or administrator action **(2)**. The request will be generated by, or sent to a GitHub action **(3)**.  The GitHub Action workflow will use the current credentials from the repository secrets **(4)** and use them to make a call to Prisma Cloud to request a new access key **(5)**.  The new access key is generated **(6)** and stored back in the repository secrets **(7)**. The new credential is now available for downstream automation processes to consume it **(8)**.

# Prerequisites
## Prisma Cloud Service Account
To deploy the sample solution, you will need a valid Service Account and Access Key. See [here](../README.md#prerequisites) for instructions on how to create one if necessary.

## Personal Access Token (PAT)
The solution will require a Personal Access Token, as the workflow will make API calls to GitHub.  To create a PAT - follow the instructoins [here](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)

## Repository Secrets
Create the following repository secrets in the repository that will host the workflow:
- PRISMA_CLOUD_ACCESS_KEY_SECRET_NAME - Secret that stores service account access key ID (i.e. "PRISMA_CLOUD_USER")
- PRISMA_CLOUD_SECRET_KEY_SECRET_NAME - Secret that stores service account secret key (i.e. "PRISMA_CLOUD_PASS")
- PRISMA_CLOUD_USER - Access key ID for the Service Account key (Note that this can have any key name - but it must correspond to the value in PRISMA_CLOUD_ACCESS_KEY_SECRET_NAME)
- PRISMA_CLOUD_PASS - Secret key for the Service Account key (Note that this can have any key name - but it must correspond to the value in PRISMA_CLOUD_SECRET_KEY_SECRET_NAME)
- PRISMA_CLOUD_CONSOLE_URL - Location of the Prisma Cloud console - i.e. "https://api.prismacloud.io"
- PERSONAL_ACCESS_TOKEN - See [Personal Access Token (PAT)] above
   
# Deployment
Use the following procedure to deploy the solution:

1. Copy key-rolling-action.yml to .github/workflows in your repository
2. Copy main.py and requirements.txt to the root of your repository

The workflow is configured to roll the keys on the 15th of every month at 00:00; update the schedule as appropriate. 
     
# Validating the deployment
Once deployed, you should be able to navigate to Actions within your repository and see the workflow "Roll Prisma Cloud Access Key".

# Testing / Manually Rolling the key
The workflow will trigger at the predefined time based on the cron schedule, however a manual trigger was also included.  To kick off the workflow:
1. Navigate to Actions
2. Click on "Roll Prisma Cloud Access Key" workflow
3. Click "Run workflow"
4. Click "Run workflow" at the "Use workflow from" dialog
   
# Cleanup
To remove the sample solution from your environment:
1. Delete the file .github/workflows/key-rolling-action.yml
2. Delete the repository secrets created in [Repository Secrets]
3. Delete the Service Account and Access Keys from Prisma Cloud - while these don't incur cost, but best practice is to remove the credentials/accounts if you're not using them

# Extending the solution
## Organizational Secrets
Your organization may use a single workflow for Prisma Cloud-related activities, or there may be mulitple workflows.  If there are multiple, you may have one Service Account or you may have multiple (e.g. one per workflow).  The solution provides for management of a repository-level secret, which will handle a single workflow with a single Service Account, or multiple workflows with multiple service accounts.  If you wish to use a single service account for multiple workflows - you will most likely want to implement GitHub secrets at the Organization level (see [here](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions#creating-secrets-for-an-organization)). The provided solution could be implemented as a workflow to manage Organization secrets but will require a few code updates specifically related to the get_pub_key() and upload_secret() methods, as the URL to the API calls for GitHub will be different. Note that Organization secrets require an upgraded GitHub subscription.
